<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ListenMachine</title>
<meta name="color-scheme" content="dark light" />
<style>
  :root{
    --ui-alpha: 0.26;
    --ui-color: rgba(255,255,255,var(--ui-alpha));
  }

  html, body { height: 100%; }
  body {
    margin: 0;
    background: #000;
    color: #fff;
    overflow: hidden;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  }

  .bgvideo{
    position: fixed; inset: 0;
    width: 100%; height: 100%;
    object-fit: cover;
    z-index: 0; pointer-events: none;
    background:#000;
    filter: saturate(0.9) contrast(1.05) blur(0.3px);
    opacity: 0;
    transition: opacity 10000ms linear;
  }
  .bgvideo.show{ opacity: 1; }

  .title-wrap{
    position: fixed;
    top: clamp(12px, 8vh, 96px);
    left: 50%; transform: translateX(-50%);
    width: min(92vw, 1200px);
    z-index: 2; text-align: center; pointer-events: none;
    padding-inline: 2vw;
  }
  #title{
    margin: 0; text-transform: uppercase; white-space: nowrap;
    letter-spacing: 0.18em; font-weight: 700; line-height: 1.06;
    color: var(--ui-color); user-select: none;
    font-size: 8vw; will-change: font-size;
  }

  .playbtn{
    position: fixed; left: 50%; top: 50%; transform: translate(-50%,-50%);
    z-index: 3; display: inline-flex; align-items: center; justify-content: center;
    padding: 14px 32px;
    border: clamp(3px, 0.6vw, 6px) solid var(--ui-color);
    border-radius: 0; background: transparent; color: var(--ui-color);
    text-transform: uppercase; font-weight: 800; letter-spacing: 0.22em;
    font-size: clamp(12px, 2.6vw, 18px); line-height: 1; cursor: pointer;
    -webkit-tap-highlight-color: transparent; touch-action: manipulation;
  }
  .hidden{ display:none !important; }

  /* Tiny toast to confirm audio start */
  .toast{
    position: fixed; right: 12px; bottom: 12px; z-index: 4;
    background: rgba(255,255,255,0.08); color:#fff; padding:10px 14px;
    border: 1px solid rgba(255,255,255,0.25);
    font-size: 12px; letter-spacing: .06em; text-transform: uppercase;
  }

  @media (prefers-reduced-motion: reduce){
    .bgvideo{ display:none; }
    body{ background:#000; }
  }
</style>
</head>
<body>

<!-- Background videos (src set by JS) -->
<video id="bgA" class="bgvideo show" muted loop playsinline preload="auto"></video>
<video id="bgB" class="bgvideo" muted loop playsinline preload="auto"></video>

<!-- Title -->
<div class="title-wrap"><h1 id="title">LISTENMACHINE</h1></div>

<!-- Center Play button -->
<button id="play" class="playbtn" type="button" aria-label="Play">PLAY</button>

<!-- Tiny toast (hidden until used) -->
<div id="toast" class="toast hidden"></div>

<!-- Hidden audio elements -->
<audio id="amb" preload="auto" playsinline></audio>
<audio id="msg" preload="auto" playsinline></audio>

<script>
/* ===================== SETTINGS / VERSION ===================== */
const VERSION = 32; // bump to bust cache when you push
const AMBIENT_FILENAME = "Aphex Twin - Stone In Focus 4.mp3";

/* -------- Auto-fit title to ONE line (never clipped) -------- */
(function(){
  const title = document.getElementById('title');
  function fit(){
    const maxWidth = title.parentElement.clientWidth;
    let size = Math.min(innerWidth * 0.08, innerHeight * 0.18, 110);
    title.style.fontSize = size + 'px';
    let safety = 80;
    while (title.scrollWidth > (maxWidth - 1.5) && safety-- > 0){
      size *= 0.965; title.style.fontSize = size + 'px';
    }
  }
  addEventListener('resize', fit, {passive:true});
  addEventListener('orientationchange', fit, {passive:true});
  addEventListener('load', fit);
  setTimeout(fit, 0);
})();
</script>

<script>
/* ===================== BACKGROUND CROSSFADE (10s switch, 10s fade) ===================== */
const BG = {
  first:  "media/Clouds2.mp4",
  second: "media/Road1.mp4",
  switchAfterMs: 10000,
  fadeMs: 10000
};

(function setupBackgroundFade(){
  const A = document.getElementById('bgA');
  const B = document.getElementById('bgB');
  A.style.transitionDuration = BG.fadeMs + 'ms';
  B.style.transitionDuration = BG.fadeMs + 'ms';

  A.src = `${BG.first}?v=${VERSION}`;
  const startA = () => { try { A.play(); } catch(e){} };
  if (A.readyState >= 2) startA(); else A.addEventListener('canplay', startA, {once:true});

  let timerStarted = false;
  function startTimer(){
    if (timerStarted) return; timerStarted = true;
    setTimeout(() => {
      B.src = `${BG.second}?v=${VERSION}`;
      const go = () => {
        try { B.currentTime = 0; } catch {}
        B.play().catch(()=>{});
        B.classList.add('show');    // fade B in
        A.classList.remove('show'); // fade A out
        setTimeout(() => {
          try { A.pause(); } catch {}
          A.removeAttribute('src'); try { A.load(); } catch {}
        }, BG.fadeMs + 60);
      };
      if (B.readyState >= 2) go(); else { B.addEventListener('canplay', go, {once:true}); try { B.load(); } catch {} }
    }, BG.switchAfterMs);
  }
  A.addEventListener('playing', startTimer, {once:true});
  setTimeout(startTimer, 1500);
})();
</script>

<script>
/* ===================== AUDIO PLAYER (LOCAL FILES) ===================== */
const FILES = {
  ambient: [ `audio/ambient/${AMBIENT_FILENAME}?v=${VERSION}` ],
  messages: [
    "audio/messages/1.mp3","audio/messages/2.mp3","audio/messages/3.mp3","audio/messages/4.mp3",
    "audio/messages/5.mp3","audio/messages/6.mp3","audio/messages/7.mp3","audio/messages/8.mp3",
    "audio/messages/9.mp3","audio/messages/10.mp3","audio/messages/11.mp3","audio/messages/12.mp3",
    "audio/messages/13.mp3","audio/messages/14.mp3","audio/messages/15.mp3","audio/messages/16.mp3",
    "audio/messages/17.mp3","audio/messages/18.mp3","audio/messages/19.mp3","audio/messages/20.mp3",
    "audio/messages/21.mp3","audio/messages/22.mp3","audio/messages/23.mp3","audio/messages/24.mp3",
    "audio/messages/25.mp3","audio/messages/26.mp3","audio/messages/27.mp3","audio/messages/28.mp3",
    "audio/messages/29.mp3","audio/messages/30.mp3","audio/messages/31.mp3","audio/messages/32.mp3",
    "audio/messages/33.mp3","audio/messages/34.mp3","audio/messages/35.mp3","audio/messages/36.mp3",
    "audio/messages/37.mp3","audio/messages/38.mp3","audio/messages/39.mp3","audio/messages/40.mp3",
    "audio/messages/41.mp3","audio/messages/42.mp3","audio/messages/43.mp3","audio/messages/44.mp3",
    "audio/messages/45.mp3","audio/messages/46.mp3","audio/messages/47.mp3","audio/messages/48.mp3",
    "audio/messages/49.mp3","audio/messages/50.mp3","audio/messages/51.mp3","audio/messages/52.mp3",
    "audio/messages/53.mp3","audio/messages/54.mp3","audio/messages/55.mp3","audio/messages/56.mp3",
    "audio/messages/57.mp3","audio/messages/58.mp3","audio/messages/59.mp3","audio/messages/60.mp3",
    "audio/messages/61.mp3","audio/messages/62.mp3","audio/messages/63.mp3","audio/messages/64.mp3",
    "audio/messages/65.mp3","audio/messages/66.mp3","audio/messages/67.mp3","audio/messages/68.mp3",
    "audio/messages/69.mp3","audio/messages/70.mp3","audio/messages/71.mp3","audio/messages/72.mp3",
    "audio/messages/73.mp3","audio/messages/74.mp3","audio/messages/75.mp3","audio/messages/76.mp3",
    "audio/messages/77.mp3","audio/messages/78.mp3"
  ]
};

const $ = s => document.querySelector(s);
const ui = { playBtn: $("#play"), amb: $("#amb"), msg: $("#msg"), toast: $("#toast") };

ui.amb.loop = false;
ui.amb.volume = 1.0;
ui.msg.volume = 0.5;

function shuffle(a){ const r=a.slice(); for(let i=r.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [r[i],r[j]]=[r[j],r[i]]; } return r; }
let msgDeck = [];
let ambDeck = [];
let messagesStarted = false;
let ambientStarted = false;
let somethingStarted = false;

function resetMsgDeck(){ msgDeck = shuffle(FILES.messages); }
function resetAmbDeck(){ ambDeck = shuffle(FILES.ambient || []); }
function showToast(txt){ ui.toast.textContent = txt; ui.toast.classList.remove('hidden'); setTimeout(()=>ui.toast.classList.add('hidden'), 2000); }

/* -------- Messages (load → play on canplay) -------- */
function clearMsgHandlers(){
  const m = ui.msg;
  m.onended = m.onerror = m.onstalled = m.onsuspend = m.onwaiting =
  m.onloadeddata = m.oncanplay = m.onplaying = m.ontimeupdate = null;
}
function nextMessage(){
  if (!msgDeck.length) return;
  const src = msgDeck.shift();
  clearMsgHandlers();

  let started = false, startTimer=null, stallTimer=null, lastT=0;
  function cleanup(){ if(startTimer) clearTimeout(startTimer); if(stallTimer) clearTimeout(stallTimer); }
  function skip(){ console.warn("Skipping stalled/failed message:", ui.msg.src); cleanup(); nextMessage(); }

  const m = ui.msg;
  m.onended = () => { cleanup(); setTimeout(nextMessage, 0); };
  m.onerror = () => { skip(); };
  m.onstalled = m.onsuspend = m.onwaiting = () => {
    if (stallTimer) clearTimeout(stallTimer);
    stallTimer = setTimeout(skip, 8000);
  };
  m.oncanplay = () => { m.play().catch(()=>{}); };
  m.onplaying = () => { started = true; somethingStarted = true; if(stallTimer){ clearTimeout(stallTimer); stallTimer=null; } if(startTimer){ clearTimeout(startTimer); startTimer=null; } };
  m.ontimeupdate = () => {
    if (m.currentTime > lastT + 0.25){ lastT = m.currentTime; if (stallTimer){ clearTimeout(stallTimer); stallTimer=null; } }
  };

  m.src = encodeURI(src);
  try { m.load(); } catch {}
  startTimer = setTimeout(() => { if(!started) skip(); }, 12000);
}

/* -------- Ambient (load → play on canplay) -------- */
function playNextAmbient(){
  ui.amb.oncanplay = ui.amb.onplaying = ui.amb.onerror = ui.amb.onended = null;

  if (!ambDeck.length){
    console.warn("No ambient in deck; messages will run without music.");
    if (!messagesStarted){ messagesStarted = true; setTimeout(nextMessage, 800); }
    return;
  }

  const src = ambDeck.shift();
  const a = ui.amb;

  a.oncanplay = () => {
    a.play().then(()=>{
      // Stone In Focus fades in—confirm visually
      showToast("Now playing: ambient");
    }).catch(e => console.warn("Ambient play() rejected:", e && e.message));
  };
  a.onplaying = () => {
    somethingStarted = true;
    if (!ambientStarted){
      ambientStarted = true;
      if (!messagesStarted){
        messagesStarted = true;
        setTimeout(nextMessage, 3000); // wait ~3s after ambient actually starts
      }
    }
  };
  a.onerror  = () => { console.warn("Ambient failed to load/play:", a.src); };

  a.src = encodeURI(src);
  try { a.load(); } catch {}
}

/* -------- Priming (safe across browsers) -------- */
function prime(el){
  el.muted = true;
  return el.play().then(() => {
    el.pause(); el.currentTime = 0; el.muted = false;
  }).catch(()=>{ el.muted = false; /* fine if it fails; click is enough */ });
}

/* -------- Visibility resume nudges -------- */
document.addEventListener('visibilitychange', () => {
  if (!document.hidden){
    if (ui.amb.paused && ambientStarted) { ui.amb.play().catch(()=>{}); }
    if (ui.msg.paused && msgDeck.length) { nextMessage(); }
  }
}, {passive:true});

/* -------- Play button logic -------- */
function showPlay(label = "PLAY"){
  ui.playBtn.textContent = label;
  ui.playBtn.classList.remove('hidden');
  ui.playBtn.style.display = '';
  ui.playBtn.disabled = false;
}
function hidePlay(){
  ui.playBtn.classList.add('hidden');
  ui.playBtn.style.display = 'none';
  ui.playBtn.disabled = true;
}

ui.playBtn.addEventListener('click', () => {
  hidePlay();

  resetMsgDeck();
  resetAmbDeck();
  messagesStarted = false;
  ambientStarted = false;
  somethingStarted = false;

  // Guaranteed message fallback so "nothing happens" can’t occur
  const msgFallback = setTimeout(() => {
    if (!messagesStarted){
      messagesStarted = true;
      nextMessage();
    }
  }, 2500);

  // Panic timer: if neither ambient nor message started, re-show PLAY
  const panic = setTimeout(() => {
    if (!somethingStarted){
      showPlay("TRY AGAIN");
    }
  }, 9000);

  // Prime + start ambient cleanly (load → canplay → play)
  Promise.all([prime(ui.amb), prime(ui.msg)].map(p => p.catch(()=>{}))).then(()=>{
    playNextAmbient();
  });
});
</script>
</body>
</html>
