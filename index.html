<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ListenMachine</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;700&display=swap" rel="stylesheet">
  <style>
    :root { --fg:#fdb; --bg:#000; }
    html,body{height:100%}
    body{
      margin:0; background:#000 url("") center/cover fixed no-repeat;
      font-family:Lato,system-ui,Arial,sans-serif; color:var(--fg);
    }
    h1{
      position:fixed; top:48px; left:0; right:0; text-align:center;
      text-transform:uppercase; letter-spacing:29px; opacity:.4;
      margin:0; font-size:clamp(32px,6vw,64px);
    }
    .ui{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      pointer-events:auto;
    }
    button{
      appearance:none; border:0; padding:16px 22px; border-radius:14px;
      background:#111; color:#fff; font-weight:700; cursor:pointer; box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .hint{
      position:fixed; bottom:20px; width:100%; text-align:center; color:#bbb; font-size:12px; letter-spacing:.5px;
    }
  </style>
</head>
<body>
  <h1>ListenMachine</h1>
  <div class="ui" id="gate"><button id="start">Start</button></div>
  <div class="hint">Refresh to reroll. Once started, ambient plays at 0.8, message fades to 0.4 after 5s.</div>

  <!-- Two simple audio elements, like the original -->
  <audio id="ambient" preload="auto" crossorigin="anonymous"></audio>
  <audio id="message" preload="auto" crossorigin="anonymous"></audio>

  <script>
    // ---------- 1) LIST YOUR FILES (relative paths in this repo) ----------
    const FILES = {
      ambient: [
        // e.g. "audio/ambient/amb01.mp3", "audio/ambient/amb02.mp3"
      ],
      messages: [
        // e.g. "audio/messages/msg01.mp3", "audio/messages/msg02.mp3"
      ]
    };
    // (Optional) If you prefer a JSON manifest, host it in your repo and set this:
    const MANIFEST_URL = null; // e.g., "manifest.json"

    // ---------- 2) Classic logic (mirrors your 2016 code) ----------
    const amb = document.getElementById('ambient');
    const msg = document.getElementById('message');
    const gate = document.getElementById('gate');
    const startBtn = document.getElementById('start');

    let A = [], M = [];    // file queues
    let ai = 0, mi = 0;    // current indices

    function shuffle(arr){
      for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
      return arr;
    }

    function nextAmbient(){
      if(!A.length) return;
      amb.src = A[ai];
      amb.volume = 0.8;
      amb.play().catch(()=>{});         // keep it resilient
      ai = (ai+1) % A.length;
    }

    function nextMessage(){
      if(!M.length) return;
      msg.src = M[mi];
      msg.volume = 0.0;                 // will fade to 0.4
      msg.play().then(()=> fadeVolume(msg, 0.4, 1000)).catch(()=>{}); 
      mi = (mi+1) % M.length;
    }

    function fadeVolume(el, target, ms){
      const start = performance.now();
      const v0 = el.volume;
      const dv = target - v0;
      function tick(t){
        const k = Math.min(1, (t - start)/ms);
        el.volume = Math.max(0, Math.min(1, v0 + dv*k));
        if(k < 1) requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);
    }

    function wireLoops(){
      amb.addEventListener('ended', nextAmbient);
      msg.addEventListener('ended', nextMessage);
      amb.addEventListener('error', nextAmbient);
      msg.addEventListener('error', nextMessage);
    }

    async function boot(){
      // Load from manifest if provided
      if (MANIFEST_URL){
        try {
          const r = await fetch(MANIFEST_URL, { cache: "no-store" });
          const j = await r.json();
          if (Array.isArray(j.ambient)) FILES.ambient = j.ambient;
          if (Array.isArray(j.messages)) FILES.messages = j.messages;
        } catch(e){ console.warn('Manifest load failed:', e); }
      }
      if (!FILES.ambient.length || !FILES.messages.length){
        alert('Add some MP3s to FILES.ambient and FILES.messages (relative URLs in this repo).');
        return;
      }
      // Shuffle once per page load (classic behaviour)
      A = shuffle([...FILES.ambient]);
      M = shuffle([...FILES.messages]);

      wireLoops();

      // Start ambient immediately, then bring in message after 5s with a fade
      nextAmbient();
      setTimeout(nextMessage, 5000);
    }

    startBtn.addEventListener('click', async ()=>{
      // Satisfy autoplay policies with one user gesture
      try { await amb.play(); amb.pause(); } catch {}
      try { await msg.play(); msg.pause(); } catch {}
      gate.style.display = 'none';
      boot();
    });
  </script>
</body>
</html>
