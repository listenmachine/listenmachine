<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ListenMachine</title>
<meta name="color-scheme" content="dark light" />
<style>
  :root{
    /* One knob for title + button colour/opacity */
    --ui-alpha: 0.26;
    --ui-color: rgba(255,255,255,var(--ui-alpha));
  }

  html, body { height: 100%; }
  body {
    margin: 0;
    background: #000;
    color: #fff;
    overflow: hidden; /* splash */
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  }

  /* Full-bleed background video */
  #bg-video{
    position: fixed;
    inset: 0;
    width: 100%; height: 100%;
    object-fit: cover;
    z-index: 0;
    pointer-events: none;
    filter: saturate(0.9) contrast(1.05) blur(0.3px); /* subtle VHS softness */
    background:#000;
  }

  /* Title near the top, single line, never clipped */
  .title-wrap{
    position: fixed;
    top: clamp(12px, 8vh, 96px);
    left: 50%;
    transform: translateX(-50%);
    width: min(92vw, 1200px);
    z-index: 2;
    text-align: center;
    pointer-events: none;
    padding-inline: 2vw;
  }
  #title{
    margin: 0;
    text-transform: uppercase;
    white-space: nowrap;          /* force one line */
    letter-spacing: 0.18em;
    font-weight: 700;
    line-height: 1.06;
    color: var(--ui-color);
    user-select: none;

    /* Start size; JS shrinks until it fits container width */
    font-size: 8vw;
    will-change: font-size;
  }

  /* Center Play button: rectangular outline + matching text */
  .playbtn{
    position: fixed;
    left: 50%; top: 50%;
    transform: translate(-50%,-50%);
    z-index: 3;

    display: inline-flex;
    align-items: center;
    justify-content: center;

    padding: 14px 32px;
    border: clamp(3px, 0.6vw, 6px) solid var(--ui-color); /* thick stroke */
    border-radius: 0;               /* rectangle */
    background: transparent;        /* no fill */
    color: var(--ui-color);         /* text matches title */
    text-transform: uppercase;
    font-weight: 800;
    letter-spacing: 0.22em;
    font-size: clamp(12px, 2.6vw, 18px);
    line-height: 1;
    cursor: pointer;

    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
  }
  .playbtn:disabled{ opacity: 1; cursor: default; }

  /* Motion/accessibility */
  @media (prefers-reduced-motion: reduce){
    #bg-video{ display:none; }
    body{ background:#000; }
  }
</style>
</head>
<body>

<!-- Background video -->
<video id="bg-video" autoplay muted loop playsinline preload="metadata" aria-hidden="true">
  <source src="media/Clouds.mp4?v=9" type="video/mp4">
</video>

<!-- Title -->
<div class="title-wrap">
  <h1 id="title">LISTENMACHINE</h1>
</div>

<!-- Center Play button -->
<button id="play" class="playbtn" type="button" aria-label="Play">PLAY</button>

<!-- Hidden audio elements -->
<audio id="amb" preload="auto" playsinline></audio>
<audio id="msg" preload="auto" playsinline></audio>

<script>
/* -------- Auto-fit title to ONE line (never clipped) -------- */
(function(){
  const title = document.getElementById('title');
  function fit(){
    const container = title.parentElement;
    const maxWidth = container.clientWidth;

    // initial size relative to viewport; capped
    let size = Math.min(window.innerWidth * 0.08, window.innerHeight * 0.18, 110); // px
    title.style.fontSize = size + 'px';

    // shrink until single-line title fits container width
    let safety = 80;
    while (title.scrollWidth > (maxWidth - 1.5) && safety-- > 0){
      size *= 0.965;
      title.style.fontSize = size + 'px';
    }
  }
  window.addEventListener('resize', fit, {passive:true});
  window.addEventListener('orientationchange', fit, {passive:true});
  window.addEventListener('load', fit);
  setTimeout(fit, 0);
})();

/* -------- Robust mobile-safe player (no repeats per session) -------- */
const FILES = {
  messages: [
    "audio/messages/1.mp3","audio/messages/2.mp3","audio/messages/3.mp3","audio/messages/4.mp3",
    "audio/messages/5.mp3","audio/messages/6.mp3","audio/messages/7.mp3","audio/messages/8.mp3",
    "audio/messages/9.mp3","audio/messages/10.mp3","audio/messages/11.mp3","audio/messages/12.mp3",
    "audio/messages/13.mp3","audio/messages/14.mp3","audio/messages/15.mp3","audio/messages/16.mp3",
    "audio/messages/17.mp3","audio/messages/18.mp3","audio/messages/19.mp3","audio/messages/20.mp3",
    "audio/messages/21.mp3","audio/messages/22.mp3","audio/messages/23.mp3","audio/messages/24.mp3",
    "audio/messages/25.mp3","audio/messages/26.mp3","audio/messages/27.mp3","audio/messages/28.mp3",
    "audio/messages/29.mp3","audio/messages/30.mp3","audio/messages/31.mp3","audio/messages/32.mp3",
    "audio/messages/33.mp3","audio/messages/34.mp3","audio/messages/35.mp3","audio/messages/36.mp3",
    "audio/messages/37.mp3","audio/messages/38.mp3","audio/messages/39.mp3","audio/messages/40.mp3",
    "audio/messages/41.mp3","audio/messages/42.mp3","audio/messages/43.mp3","audio/messages/44.mp3",
    "audio/messages/45.mp3","audio/messages/46.mp3","audio/messages/47.mp3","audio/messages/48.mp3",
    "audio/messages/49.mp3","audio/messages/50.mp3","audio/messages/51.mp3","audio/messages/52.mp3",
    "audio/messages/53.mp3","audio/messages/54.mp3","audio/messages/55.mp3","audio/messages/56.mp3",
    "audio/messages/57.mp3","audio/messages/58.mp3","audio/messages/59.mp3","audio/messages/60.mp3",
    "audio/messages/61.mp3","audio/messages/62.mp3","audio/messages/63.mp3","audio/messages/64.mp3",
    "audio/messages/65.mp3","audio/messages/66.mp3","audio/messages/67.mp3","audio/messages/68.mp3",
    "audio/messages/69.mp3","audio/messages/70.mp3","audio/messages/71.mp3","audio/messages/72.mp3",
    "audio/messages/73.mp3","audio/messages/74.mp3","audio/messages/75.mp3","audio/messages/76.mp3",
    "audio/messages/77.mp3","audio/messages/78.mp3"
  ],
  ambient: [
    "audio/ambient/Aphex Twin - Stone In Focus 4.mp3"  // chosen once per refresh
  ]
};

const $ = s => document.querySelector(s);
const ui = { playBtn: $("#play"), amb: $("#amb"), msg: $("#msg") };

ui.amb.loop = false;  // ambient plays once per session
ui.amb.volume = 1.0;  // defaults
ui.msg.volume = 0.5;

/* shuffle helper */
function shuffle(a){ const r=a.slice(); for(let i=r.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [r[i],r[j]]=[r[j],r[i]]; } return r; }
let deck = [];
function resetDeck(){ deck = shuffle(FILES.messages); }

/* Cleanly rewire handlers each track */
function clearMsgHandlers(){
  const m = ui.msg;
  m.onended = m.onerror = m.onstalled = m.onsuspend = m.onwaiting =
  m.onloadeddata = m.oncanplay = m.onplaying = m.ontimeupdate = null;
}

/* Play next message with watchdogs to skip stalls */
function nextMessage(){
  if (ui.amb.ended) return;     // stop chain when ambient is over
  if (!deck.length) return;

  const src = deck.shift();
  clearMsgHandlers();

  let started = false;
  let startTimer = null;
  let stallTimer = null;
  let lastT = 0;

  function cleanupTimers(){ if(startTimer) clearTimeout(startTimer); if(stallTimer) clearTimeout(stallTimer); startTimer = stallTimer = null; }
  function skip(){ cleanupTimers(); nextMessage(); }

  const m = ui.msg;

  m.onended = () => { cleanupTimers(); setTimeout(nextMessage, 0); };
  m.onerror  = () => { skip(); };
  m.onstalled = m.onsuspend = m.onwaiting = () => {
    if (stallTimer) clearTimeout(stallTimer);
    stallTimer = setTimeout(skip, 8000);  // if stalled too long, skip
  };
  m.onloadeddata = m.oncanplay = () => {
    // try to start once we have data
    m.play().catch(()=>{});  // if not ready, startTimer below will still guard
  };
  m.onplaying = () => {
    started = true;
    if (stallTimer) { clearTimeout(stallTimer); stallTimer = null; }
    if (startTimer) { clearTimeout(startTimer); startTimer = null; }
  };
  m.ontimeupdate = () => {
    if (m.currentTime > lastT + 0.25){
      lastT = m.currentTime;
      if (stallTimer){ clearTimeout(stallTimer); stallTimer = null; }
    }
  };

  m.src = encodeURI(src);
  try { m.load(); } catch {}

  // If it doesn't actually begin within 12s, skip it
  startTimer = setTimeout(() => { if(!started) skip(); }, 12000);

  // First attempt to play (some browsers accept this immediately)
  m.play().catch(()=>{}); // ignore; we'll be gated by the timers/events above
}

/* Prime audio after user gesture (iOS/WebKit quirks) */
function prime(el){
  el.muted = true;
  return el.play().then(() => {
    el.pause(); el.currentTime = 0; el.muted = false;
  }).catch(()=>{ el.muted = false; });
}

/* Resume logic if user returns to the tab/app */
document.addEventListener('visibilitychange', () => {
  if (!document.hidden && !ui.amb.ended && ui.msg.paused && deck.length){
    // Nudge the chain if we came back from background
    nextMessage();
  }
}, {passive:true});

ui.playBtn.addEventListener('click', () => {
  ui.playBtn.disabled = true; // prevent double-starts

  resetDeck();
  const ambPick = shuffle(FILES.ambient)[0];

  ui.amb.onerror = () => { ui.playBtn.disabled = false; };
  ui.amb.onended = () => { try{ ui.msg.pause(); }catch{} ui.playBtn.disabled = false; };

  ui.amb.src = encodeURI(ambPick);
  ui.amb.currentTime = 0;

  Promise.allSettled([prime(ui.amb), prime(ui.msg)]).finally(() => {
    ui.amb.play().then(() => { nextMessage(); })
      .catch(() => { ui.playBtn.disabled = false; });
  });

  try{ ui.amb.load(); ui.msg.load(); }catch{}
});
</script>
</body>
</html>
