<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ListenMachine</title>
<style>
  /* Base */
  :root { color-scheme: light dark; }
  html,body{height:100%}
  body{margin:0;font-family:system-ui,Arial,sans-serif;background:#000;color:#111}

  /* Full-bleed background video */
  #bg-video{
    position:fixed; inset:0;
    width:100%; height:100%;
    object-fit:cover;
    z-index:0;             /* behind UI */
    pointer-events:none;   /* never intercept clicks/taps */
    background:#000;       /* while first frame loads */
    filter: contrast(1.05) saturate(0.92) blur(0.2px);
  }

  /* Layout / card */
  .wrap{min-height:100vh;display:grid;place-items:center;padding:24px;position:relative;z-index:1}
  .card{
    max-width:740px;width:100%;
    /* Make this slightly translucent so you can see the video working.
       Change to background:#fff if you want solid. */
    background: rgba(255,255,255,0.92);
    backdrop-filter: blur(1px);
    border-radius:16px;
    box-shadow:0 20px 50px rgba(0,0,0,.18);
    padding:24px
  }
  h1{margin:0 0 8px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  button{border:0;padding:12px 16px;border-radius:12px;background:#111;color:#fff;font-weight:600;cursor:pointer}
  .pill{background:#f0f0f0;border-radius:999px;padding:6px 10px;font-size:13px}
  .grid{display:grid;gap:10px;grid-template-columns:1fr 1fr;margin-top:10px}
  label{font-size:12px;color:#444;margin-bottom:4px;display:block}
  input[type="range"]{width:100%}
  #status{font-size:12px;color:#666;margin-top:8px}
  audio{display:none}

  /* Respect reduced motion */
  @media (prefers-reduced-motion: reduce){
    #bg-video{display:none}
    body{background:#000}
    .card{background:#fff}
  }
</style>
</head>
<body>

<!-- Looping background video -->
<video id="bg-video"
  autoplay
  muted
  loop
  playsinline
  webkit-playsinline
  preload="metadata"
  aria-hidden="true">
  <source src="media/Clouds.mp4?v=1" type="video/mp4">
  <!-- Add a WebM <source> above later if you export one -->
</video>

<div class="wrap">
  <main class="card">
    <h1>ListenMachine</h1>
    <p>Ambient plays once at full volume; messages play at half volume over it, <b>no repeats per session</b>.</p>

    <div class="row"><button id="start">Play</button><span id="status"></span></div>

    <div class="row" style="margin-top:10px;gap:8px">
      <span class="pill">Ambient: <span id="ambName">—</span></span>
      <span class="pill">Message: <span id="msgName">—</span></span>
    </div>

    <div class="grid">
      <div><label for="msgVol">Message volume</label><input id="msgVol" type="range" min="0" max="1" step="0.01" value="0.5"></div>
      <div><label for="ambVol">Ambient volume</label><input id="ambVol" type="range" min="0" max="1" step="0.01" value="1.0"></div>
    </div>

    <audio id="amb" preload="auto" playsinline></audio>
    <audio id="msg" preload="auto" playsinline></audio>
  </main>
</div>

<script>
/* ---- Your files ---- */
const FILES = {
  messages: [
    "audio/messages/1.mp3","audio/messages/2.mp3","audio/messages/3.mp3","audio/messages/4.mp3",
    "audio/messages/5.mp3","audio/messages/6.mp3","audio/messages/7.mp3","audio/messages/8.mp3",
    "audio/messages/9.mp3","audio/messages/10.mp3","audio/messages/11.mp3","audio/messages/12.mp3",
    "audio/messages/13.mp3","audio/messages/14.mp3","audio/messages/15.mp3","audio/messages/16.mp3",
    "audio/messages/17.mp3","audio/messages/18.mp3","audio/messages/19.mp3","audio/messages/20.mp3",
    "audio/messages/21.mp3","audio/messages/22.mp3","audio/messages/23.mp3","audio/messages/24.mp3",
    "audio/messages/25.mp3","audio/messages/26.mp3","audio/messages/27.mp3","audio/messages/28.mp3",
    "audio/messages/29.mp3","audio/messages/30.mp3","audio/messages/31.mp3","audio/messages/32.mp3",
    "audio/messages/33.mp3","audio/messages/34.mp3","audio/messages/35.mp3","audio/messages/36.mp3",
    "audio/messages/37.mp3","audio/messages/38.mp3","audio/messages/39.mp3","audio/messages/40.mp3",
    "audio/messages/41.mp3","audio/messages/42.mp3","audio/messages/43.mp3","audio/messages/44.mp3",
    "audio/messages/45.mp3","audio/messages/46.mp3","audio/messages/47.mp3","audio/messages/48.mp3",
    "audio/messages/49.mp3","audio/messages/50.mp3","audio/messages/51.mp3","audio/messages/52.mp3",
    "audio/messages/53.mp3","audio/messages/54.mp3","audio/messages/55.mp3","audio/messages/56.mp3",
    "audio/messages/57.mp3","audio/messages/58.mp3","audio/messages/59.mp3","audio/messages/60.mp3",
    "audio/messages/61.mp3","audio/messages/62.mp3","audio/messages/63.mp3","audio/messages/64.mp3",
    "audio/messages/65.mp3","audio/messages/66.mp3","audio/messages/67.mp3","audio/messages/68.mp3",
    "audio/messages/69.mp3","audio/messages/70.mp3","audio/messages/71.mp3","audio/messages/72.mp3",
    "audio/messages/73.mp3","audio/messages/74.mp3","audio/messages/75.mp3","audio/messages/76.mp3",
    "audio/messages/77.mp3","audio/messages/78.mp3"
  ],
  ambient: [
    "audio/ambient/Aphex Twin - Stone In Focus 4.mp3"  // add more later; one chosen per refresh
  ]
};

const $ = id => document.getElementById(id);
const ui = {
  start: $("start"),
  status: $("status"),
  ambName: $("ambName"),
  msgName: $("msgName"),
  ambVol: $("ambVol"),
  msgVol: $("msgVol"),
  amb: $("amb"),
  msg: $("msg"),
};

/* volumes (defaults requested) */
ui.amb.loop = false; // ambient plays once per session
ui.amb.volume = parseFloat(ui.ambVol.value); // 1.0
ui.msg.volume = parseFloat(ui.msgVol.value); // 0.5
ui.ambVol.addEventListener('input', () => ui.amb.volume = parseFloat(ui.ambVol.value));
ui.msgVol.addEventListener('input', () => ui.msg.volume = parseFloat(ui.msgVol.value));

/* utils */
const nameOf = p => decodeURIComponent(p.split('/').pop());
const setStatus = t => ui.status.textContent = t;
function shuffle(a){ const r=a.slice(); for(let i=r.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [r[i],r[j]]=[r[j],r[i]]; } return r; }

/* session deck (no repeats) */
let deck = [];
function resetDeck(){ deck = shuffle(FILES.messages); }

/* play next unique message, if any */
function nextMessage(){
  if (ui.amb.ended) return;              // session ends with ambient
  if (!deck.length){ setStatus("All messages played once."); return; }

  const src = deck.shift();
  ui.msgName.textContent = nameOf(src);

  // Attach handlers BEFORE setting src so we never miss events
  ui.msg.onerror = () => { setStatus("Message failed, skipping…"); nextMessage(); };
  ui.msg.onended = () => { setTimeout(nextMessage, 10); };

  ui.msg.src = encodeURI(src);
  ui.msg.currentTime = 0;

  ui.msg.play().catch(() => {
    // Some browsers reject the first play even after a user gesture; nudge once more.
    setTimeout(() => ui.msg.play().catch(()=>{}), 50);
  });
}

/* prime audio elements to satisfy stricter autoplay engines */
function prime(el){
  el.muted = true;
  return el.play().then(() => {
    el.pause(); el.currentTime = 0; el.muted = false;
  }).catch(()=>{ el.muted = false; });
}

ui.start.addEventListener('click', () => {
  ui.start.disabled = true;
  setStatus("Starting…");

  resetDeck();

  // Choose one ambient per refresh
  const ambPick = shuffle(FILES.ambient)[0];
  ui.ambName.textContent = nameOf(ambPick);

  // Wire ambient handlers BEFORE src
  ui.amb.onerror = () => { setStatus("Ambient failed to load. Check path/filename."); ui.start.disabled = false; };
  ui.amb.onended = () => {
    try { ui.msg.pause(); } catch {}
    setStatus("Ambient ended.");
    ui.start.disabled = false;
    ui.start.textContent = 'Play again';
  };

  ui.amb.src = encodeURI(ambPick);
  ui.amb.currentTime = 0;

  // Prime both, then start ambient, then start message chain
  Promise.allSettled([prime(ui.amb), prime(ui.msg)]).finally(() => {
    ui.amb.play().then(() => {
      setStatus("Playing…");
      nextMessage();
    }).catch(() => {
      setStatus("Playback blocked. Tap Play again.");
      ui.start.disabled = false;
    });
  });

  // Kick loads explicitly (helps a few browsers)
  try { ui.amb.load(); ui.msg.load(); } catch {}
});
</script>
</body>
</html>
