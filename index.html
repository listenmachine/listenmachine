<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ListenMachine</title>
<meta name="color-scheme" content="dark light" />

<!-- Preconnects for faster GitHub API/raw fetch -->
<link rel="preconnect" href="https://api.github.com" crossorigin>
<link rel="preconnect" href="https://raw.githubusercontent.com" crossorigin>

<style>
  :root{
    --ui-alpha: 0.26;
    --ui-color: rgba(255,255,255,var(--ui-alpha));
    --title-blur: 0px;
    --title-opacity: 1;
    --title-fade-ms: 20000ms;
    --bg-filter: saturate(0.95) contrast(0.96) brightness(1.06) blur(0px);
  }

  html, body { height: 100%; }
  body {
    margin: 0;
    background: #000;
    color: #fff;
    overflow: hidden;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  }

  /* Background videos with crossfade */
  .bgvideo{
    position: fixed;
    inset: 0;
    width: 100%; height: 100%;
    object-fit: cover;
    z-index: 0;
    pointer-events: none;
    background:#000;
    filter: var(--bg-filter);
    opacity: 0;
    transition: opacity 20000ms linear;
    will-change: opacity;
    contain: paint;
    backface-visibility: hidden;
  }
  .bgvideo.show{ opacity: 1; }

  .title-wrap{
    position: fixed;
    top: clamp(12px, 8vh, 96px);
    left: 50%;
    transform: translateX(-50%);
    width: min(92vw, 1200px);
    z-index: 2;
    text-align: center;
    pointer-events: none;
    padding-inline: 2vw;
    isolation: isolate;
  }
  #title{
    margin: 0;
    text-transform: uppercase;
    white-space: nowrap;
    letter-spacing: 0.18em;
    font-weight: 700;
    line-height: 1.06;
    color: var(--ui-color);
    user-select: none;
    font-size: 8vw; /* auto-shrinks via JS */
    will-change: font-size, filter, opacity;
    mix-blend-mode: soft-light;
    filter: blur(var(--title-blur));
    opacity: var(--title-opacity);
    transition: filter var(--title-fade-ms) linear, opacity var(--title-fade-ms) linear;
  }

  /* Play button (shares title blur/fade) */
  .uibtn{
    position: fixed;
    left: 50%; top: 50%;
    transform: translate(-50%,-50%);
    z-index: 3;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 14px 32px;
    border: none;
    outline: none;
    background: transparent;
    color: var(--ui-color);
    text-transform: uppercase;
    font-weight: 800;
    letter-spacing: 0.22em;
    font-size: clamp(12px, 2.6vw, 18px);
    line-height: 1;
    cursor: pointer;
    mix-blend-mode: overlay;
    isolation: isolate;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;

    filter: blur(0px);
    opacity: 1;
    transition: filter var(--title-fade-ms) linear, opacity var(--title-fade-ms) linear;
  }
  .uibtn:focus{ outline: none; }
  .hidden{ display:none !important; }
  .fade-out{ filter: blur(30px); opacity: 0; }

  @media (prefers-reduced-motion: reduce){
    .bgvideo{ transition: none; }
    .uibtn{ transition: none; }
    #title{ transition: none; }
  }

  /* Mobile perf tweaks: remove filters & blend modes for cheaper compositing */
  @media (pointer: coarse), (max-width: 820px){
    :root{ --bg-filter: none; }
    #title, .uibtn{ mix-blend-mode: normal; }
  }
</style>
</head>
<body>

<!-- Background videos -->
<video id="bgA" class="bgvideo show" muted loop playsinline preload="auto" src="media/Clouds4.mp4?v=17"></video>
<video id="bgB" class="bgvideo"        muted loop playsinline preload="auto" src="media/Nightsky.mp4?v=17"></video>
<video id="bgC" class="bgvideo"        muted loop playsinline preload="auto" src="media/Road2.mp4?v=17"></video>
<video id="bgD" class="bgvideo"        muted loop playsinline preload="auto" src="media/Forest.mp4?v=17"></video>
<video id="bgE" class="bgvideo"        muted loop playsinline preload="auto" src="media/Snow3.mp4?v=17"></video>

<!-- Title -->
<div class="title-wrap">
  <h1 id="title">LISTENMACHINE</h1>
</div>

<!-- Play -->
<button id="play" class="uibtn" type="button" aria-label="Play">PLAY</button>

<!-- Audio sinks -->
<audio id="sink" preload="auto" playsinline></audio>   <!-- WebAudio sink (unused unless BACKGROUND_MODE='full') -->
<audio id="ambEl" preload="auto" playsinline></audio>  <!-- Mobile ambient fallback -->

<script>
/* -------- Auto-fit title to ONE line -------- */
(function(){
  const title = document.getElementById('title');
  function fit(){
    const container = title.parentElement;
    const maxWidth = container.clientWidth;
    let size = Math.min(window.innerWidth * 0.08, window.innerHeight * 0.18, 110);
    title.style.fontSize = size + 'px';
    let safety = 80;
    while (title.scrollWidth > (maxWidth - 1.5) && safety-- > 0){
      size *= 0.965;
      title.style.fontSize = size + 'px';
    }
  }
  addEventListener('resize', fit, {passive:true});
  addEventListener('orientationchange', fit, {passive:true});
  addEventListener('load', fit);
  setTimeout(fit, 0);
})();
</script>

<script>
/* ===== BACKGROUND LOOP with mobile perf optimizations ===== */
const IS_MOBILE = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);

/* Shorter overlap on mobile, keep your long dissolve on desktop */
const BG = {
  displayMs: IS_MOBILE ? 7000  : 5000,
  fadeMs:    IS_MOBILE ? 9000  : 55000,
  firstHoldAfterClickMs: 10000
};

(function setupBackgroundLoop(){
  const vids = ['bgA','bgB','bgC','bgD','bgE'].map(id => document.getElementById(id));

  /* Play only the current and next videos; pause the rest */
  let i = 0;
  function playOnlyCurrentAndNext(idx){
    const nextIdx = (idx + 1) % vids.length;
    vids.forEach((v, k) => {
      try {
        if (k === idx || k === nextIdx) { v.play(); }
        else { v.pause(); }
      } catch(e){}
    });
  }

  function crossfade(){
    c
