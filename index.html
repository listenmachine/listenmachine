<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ListenMachine</title>
<meta name="color-scheme" content="dark light" />
<style>
  :root{
    /* One knob for title + button colour/opacity */
    --ui-alpha: 0.26;
    --ui-color: rgba(255,255,255,var(--ui-alpha));
  }

  html, body { height: 100%; }
  body {
    margin: 0;
    background: #000;
    color: #fff;
    overflow: hidden;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  }

  /* Stacked background videos for crossfade */
  .bgvideo{
    position: fixed;
    inset: 0;
    width: 100%; height: 100%;
    object-fit: cover;
    z-index: 0;
    pointer-events: none;
    background:#000;
    filter: saturate(0.9) contrast(1.05) blur(0.3px);
    opacity: 0;
    transition: opacity 10000ms linear; /* JS syncs to BG.fadeMs */
  }
  .bgvideo.show{ opacity: 1; }

  /* Title near the top, single line, never clipped */
  .title-wrap{
    position: fixed;
    top: clamp(12px, 8vh, 96px);
    left: 50%;
    transform: translateX(-50%);
    width: min(92vw, 1200px);
    z-index: 2;
    text-align: center;
    pointer-events: none;
    padding-inline: 2vw;
  }
  #title{
    margin: 0;
    text-transform: uppercase;
    white-space: nowrap;          /* force one line */
    letter-spacing: 0.18em;
    font-weight: 700;
    line-height: 1.06;
    color: var(--ui-color);
    user-select: none;

    /* Start size; JS shrinks until it fits container width */
    font-size: 8vw;
    will-change: font-size;
  }

  /* Center Play button */
  .playbtn{
    position: fixed;
    left: 50%; top: 50%;
    transform: translate(-50%,-50%);
    z-index: 3;

    display: inline-flex;
    align-items: center;
    justify-content: center;

    padding: 14px 32px;
    border: clamp(3px, 0.6vw, 6px) solid var(--ui-color);
    border-radius: 0;
    background: transparent;
    color: var(--ui-color);
    text-transform: uppercase;
    font-weight: 800;
    letter-spacing: 0.22em;
    font-size: clamp(12px, 2.6vw, 18px);
    line-height: 1;
    cursor: pointer;

    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
  }
  .hidden{ display:none !important; }

  @media (prefers-reduced-motion: reduce){
    .bgvideo{ display:none; }
    body{ background:#000; }
  }
</style>
</head>
<body>

<!-- Background videos -->
<!-- A (Clouds) starts visible immediately so something shows even if JS fails -->
<video id="bgA" class="bgvideo show" muted loop playsinline preload="auto">
  <source src="media/Clouds2.mp4?v=16" type="video/mp4">
</video>
<!-- B (Road) and C (Forest) are stacked underneath; JS handles crossfades -->
<video id="bgB" class="bgvideo" muted loop playsinline preload="auto" src="media/Road1.mp4?v=16"></video>
<video id="bgC" class="bgvideo" muted loop playsinline preload="auto" src="media/Forest.mp4?v=16"></video>

<!-- Title -->
<div class="title-wrap">
  <h1 id="title">LISTENMACHINE</h1>
</div>

<!-- Center Play button -->
<button id="play" class="playbtn" type="button" aria-label="Play">PLAY</button>

<!-- Hidden audio elements -->
<audio id="amb" preload="auto" playsinline></audio>
<audio id="msg" preload="auto" playsinline></audio>

<script>
/* Minimal polyfill for Promise.allSettled (older Safari/Chromium variants) */
if (!Promise.allSettled) {
  Promise.allSettled = function(promises){
    return Promise.all(promises.map(p => Promise.resolve(p)
      .then(value => ({status: "fulfilled", value}))
      .catch(reason => ({status: "rejected", reason}))
    ));
  };
}
</script>

<script>
/* -------- Auto-fit title to ONE line (never clipped) -------- */
(function(){
  const title = document.getElementById('title');
  function fit(){
    const container = title.parentElement;
    const maxWidth = container.clientWidth;

    let size = Math.min(window.innerWidth * 0.08, window.innerHeight * 0.18, 110); // px
    title.style.fontSize = size + 'px';

    let safety = 80;
    while (title.scrollWidth > (maxWidth - 1.5) && safety-- > 0){
      size *= 0.965;
      title.style.fontSize = size + 'px';
    }
  }
  addEventListener('resize', fit, {passive:true});
  addEventListener('orientationchange', fit, {passive:true});
  addEventListener('load', fit);
  setTimeout(fit, 0);
})();
</script>

<script>
/* ===================== BACKGROUND CROSSFADE (Clouds → Road → Forest → Clouds) ===================== */
const BG = {
  displayMs: 60000,  // time fully visible between fades
  fadeMs: 10000      // crossfade duration
};

(function setupBackgroundLoop(){
  const A = document.getElementById('bgA'); // Clouds
  const B = document.getElementById('bgB'); // Road
  const C = document.getElementById('bgC'); // Forest

  const vids = [A, B, C]; // order defines cycle: Clouds → Road → Forest → Clouds

  // Keep CSS transition in sync with fadeMs and try to play all
  vids.forEach(v => {
    v.style.transitionDuration = BG.fadeMs + 'ms';
    const tryPlay = () => { try { v.play(); } catch(e){} };
    if (v.readyState >= 2) tryPlay();
    else v.addEventListener('canplay', tryPlay, { once: true });
  });

  let i = 0; // index of currently visible video in vids
  let started = false;

  function crossfade(){
    const cur = vids[i];
    const next = vids[(i + 1) % vids.length];

    try { next.currentTime = next.currentTime || 0; } catch {}
    try { next.play(); } catch {}

    next.classList.add('show');
    cur.classList.remove('show');

    i = (i + 1) % vids.length;

    // After a fade completes, the new clip sits fully visible for displayMs
    setTimeout(crossfade, BG.displayMs + BG.fadeMs);
  }

  function
