<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ListenMachine</title>
<meta name="color-scheme" content="dark light" />
<style>
  :root{
    /* single place to tweak overall opacity tint for both title & button */
    --ui-alpha: 0.26;
  }
  html, body { height: 100%; }
  body {
    margin: 0;
    background: #000;
    color: #fff;
    overflow: hidden; /* pure splash */
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  }

  /* Full-bleed background video */
  #bg-video{
    position: fixed;
    inset: 0;
    width: 100%; height: 100%;
    object-fit: cover;
    z-index: 0;
    pointer-events: none;
    background:#000;
    filter: saturate(0.9) contrast(1.05) blur(0.3px); /* subtle VHS-ish softness */
  }

  /* Title near the top */
  .title-wrap{
    position: fixed;
    top: clamp(16px, 8vh, 100px);
    left: 50%;
    transform: translateX(-50%);
    width: 92vw;           /* available width for fitting */
    max-width: 1200px;
    z-index: 2;
    text-align: center;
    pointer-events: none;
    padding-inline: 2vw;
  }
  #title{
    margin: 0;
    text-transform: uppercase;
    white-space: nowrap;    /* force one line */
    letter-spacing: 0.18em; /* wide, but reasonable on phones */
    font-weight: 700;
    line-height: 1.06;
    color: rgba(255,255,255,var(--ui-alpha));
    user-select: none;
    /* initial size; JS will auto-fit down if needed */
    font-size: 9vw;
    /* prevents subpixel blur when we scale font-size repeatedly */
    will-change: font-size;
  }

  /* Center Play button (SVG with text knockout) */
  .playbtn{
    position: fixed;
    left: 50%; top: 50%;
    transform: translate(-50%,-50%);
    z-index: 3;

    border: none;
    padding: 0;
    background: transparent;
    cursor: pointer;

    /* improve click target on very small screens */
    touch-action: manipulation;
  }
  .playbtn:disabled{ opacity: 0.55; cursor: default; }

  .playbtn svg{
    display: block;
    width: min(60vw, 320px);
    height: auto;
  }

  /* Motion/accessibility */
  @media (prefers-reduced-motion: reduce){
    #bg-video{ display:none; }
    body{ background:#000; }
  }
</style>
</head>
<body>

<!-- Background video (muted+playsinline so it autoplays on mobile) -->
<video id="bg-video" autoplay muted loop playsinline preload="metadata" aria-hidden="true">
  <source src="media/Clouds.mp4?v=6" type="video/mp4">
</video>

<!-- Minimal title (auto-fitted via JS to one line) -->
<div class="title-wrap">
  <h1 id="title">LISTENMACHINE</h1>
</div>

<!-- Center Play control: white pill with knockout "PLAY" -->
<button id="play" class="playbtn" type="button" aria-label="Play">
  <svg viewBox="0 0 320 56" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
    <defs>
      <!-- Mask: white reveals, black cuts out text -->
      <mask id="cutout">
        <rect x="0" y="0" width="320" height="56" rx="28" fill="#fff"/>
        <text x="50%" y="50%"
              fill="#000"
              font-family="system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif"
              font-weight="800"
              font-size="20"
              text-anchor="middle"
              dominant-baseline="middle"
              letter-spacing="0.22em"
              style="text-transform:uppercase">PLAY</text>
      </mask>
    </defs>
    <!-- The pill uses the mask so the word becomes transparent -->
    <rect x="0" y="0" width="320" height="56" rx="28"
          fill="#fff" fill-opacity="var(--ui-alpha)"
          mask="url(#cutout)"/>
  </svg>
</button>

<!-- Hidden audio elements -->
<audio id="amb" preload="auto" playsinline></audio>
<audio id="msg" preload="auto" playsinline></audio>

<script>
/* -------- Auto-fit title to one line (never clipped) -------- */
(function(){
  const title = document.getElementById('title');
  function fit(){
    // available width inside the title container
    const container = title.parentElement;
    const maxWidth = container.clientWidth;
    // start with a size relative to viewport
    let size = Math.min(window.innerWidth * 0.09, window.innerHeight * 0.18, 120); // px cap
    title.style.fontSize = size + 'px';

    // shrink until it fits on one line within container width
    let safety = 60;
    // Measure using scrollWidth vs container width (1.5px buffer for rounding)
    while (title.scrollWidth > (maxWidth - 1.5) && safety-- > 0){
      size *= 0.96;
      title.style.fontSize = size + 'px';
    }
  }
  window.addEventListener('resize', fit, {passive:true});
  window.addEventListener('orientationchange', fit, {passive:true});
  window.addEventListener('load', fit);
  // in case fonts/render tick happens after load
  setTimeout(fit, 0);
})();

/* -------- Minimal player (no repeats per session) -------- */
const FILES = {
  messages: [
    "audio/messages/1.mp3","audio/messages/2.mp3","audio/messages/3.mp3","audio/messages/4.mp3",
    "audio/messages/5.mp3","audio/messages/6.mp3","audio/messages/7.mp3","audio/messages/8.mp3",
    "audio/messages/9.mp3","audio/messages/10.mp3","audio/messages/11.mp3","audio/messages/12.mp3",
    "audio/messages/13.mp3","audio/messages/14.mp3","audio/messages/15.mp3","audio/messages/16.mp3",
    "audio/messages/17.mp3","audio/messages/18.mp3","audio/messages/19.mp3","audio/messages/20.mp3",
    "audio/messages/21.mp3","audio/messages/22.mp3","audio/messages/23.mp3","audio/messages/24.mp3",
    "audio/messages/25.mp3","audio/messages/26.mp3","audio/messages/27.mp3","audio/messages/28.mp3",
    "audio/messages/29.mp3","audio/messages/30.mp3","audio/messages/31.mp3","audio/messages/32.mp3",
    "audio/messages/33.mp3","audio/messages/34.mp3","audio/messages/35.mp3","audio/messages/36.mp3",
    "audio/messages/37.mp3","audio/messages/38.mp3","audio/messages/39.mp3","audio/messages/40.mp3",
    "audio/messages/41.mp3","audio/messages/42.mp3","audio/messages/43.mp3","audio/messages/44.mp3",
    "audio/messages/45.mp3","audio/messages/46.mp3","audio/messages/47.mp3","audio/messages/48.mp3",
    "audio/messages/49.mp3","audio/messages/50.mp3","audio/messages/51.mp3","audio/messages/52.mp3",
    "audio/messages/53.mp3","audio/messages/54.mp3","audio/messages/55.mp3","audio/messages/56.mp3",
    "audio/messages/57.mp3","audio/messages/58.mp3","audio/messages/59.mp3","audio/messages/60.mp3",
    "audio/messages/61.mp3","audio/messages/62.mp3","audio/messages/63.mp3","audio/messages/64.mp3",
    "audio/messages/65.mp3","audio/messages/66.mp3","audio/messages/67.mp3","audio/messages/68.mp3",
    "audio/messages/69.mp3","audio/messages/70.mp3","audio/messages/71.mp3","audio/messages/72.mp3",
    "audio/messages/73.mp3","audio/messages/74.mp3","audio/messages/75.mp3","audio/messages/76.mp3",
    "audio/messages/77.mp3","audio/messages/78.mp3"
  ],
  ambient: [
    "audio/ambient/Aphex Twin - Stone In Focus 4.mp3"
  ]
};

const $ = s => document.querySelector(s);
const ui = { playBtn: $("#play"), amb: $("#amb"), msg: $("#msg") };

ui.amb.loop = false;  // ambient plays once per session
ui.amb.volume = 1.0;  // defaults
ui.msg.volume = 0.5;

function shuffle(a){ const r=a.slice(); for(let i=r.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [r[i],r[j]]=[r[j],r[i]]; } return r; }
let deck = [];
function resetDeck(){ deck = shuffle(FILES.messages); }

function nextMessage(){
  if (ui.amb.ended) return;
  if (!deck.length) return;

  const src = deck.shift();
  ui.msg.onerror = () => { nextMessage(); };
  ui.msg.onended = () => { setTimeout(nextMessage, 10); };

  ui.msg.src = encodeURI(src);
  ui.msg.currentTime = 0;
  ui.msg.play().catch(() => { setTimeout(() => ui.msg.play().catch(()=>{}), 50); });
}

function prime(el){
  el.muted = true;
  return el.play().then(() => {
    el.pause(); el.currentTime = 0; el.muted = false;
  }).catch(()=>{ el.muted = false; });
}

ui.playBtn.addEventListener('click', () => {
  ui.playBtn.disabled = true;

  resetDeck();
  const ambPick = shuffle(FILES.ambient)[0];

  ui.amb.onerror = () => { ui.playBtn.disabled = false; };
  ui.amb.onended = () => { try{ ui.msg.pause(); }catch{} ui.playBtn.disabled = false; };

  ui.amb.src = encodeURI(ambPick);
  ui.amb.currentTime = 0;

  Promise.allSettled([prime(ui.amb), prime(ui.msg)]).finally(() => {
    ui.amb.play().then(() => { nextMessage(); })
      .catch(() => { ui.playBtn.disabled = false; });
  });

  try{ ui.amb.load(); ui.msg.load(); }catch{}
});
</script>
</body>
</html>
